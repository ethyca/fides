"""Tests for the webserver and its various configurations."""

import pytest
from fastapi import FastAPI
from httpx import AsyncClient
from starlette.testclient import TestClient

from fides.api.main import create_fides_app, lifespan
from fides.api.oauth.utils import (
    get_root_client,
    verify_oauth_client,
    verify_oauth_client_prod,
)
from fides.common.api.v1.urn_registry import V1_URL_PREFIX
from fides.config.security_settings import SecuritySettings


def test_read_autogenerated_docs(api_client: TestClient):
    """Test to ensure automatically generated docs build properly"""
    response = api_client.get("/openapi.json")
    assert response.status_code == 200


class TestConfigureSecurityEnvOverrides:

    def test_configure_security_env_overrides_dev(self) -> None:
        """
        This test verifies that when set to 'dev', only the
        cli-related endpoints default to the root user.
        """
        security_env = "dev"
        test_app = FastAPI(title="test")
        test_app = create_fides_app(lifespan=lifespan, security_env=security_env)
        assert (
            test_app.dependency_overrides[verify_oauth_client_prod] == get_root_client
        )

    @pytest.mark.asyncio
    async def test_configure_security_env_overrides_prod(self) -> None:
        """
        This test verifies that when set to 'prod', there are no
        dependency overrides for the oauth clients.
        """
        security_env = "prod"
        test_app = FastAPI(title="test")
        test_app = create_fides_app(lifespan=lifespan, security_env=security_env)
        with pytest.raises(KeyError):
            test_app.dependency_overrides[verify_oauth_client]

        with pytest.raises(KeyError):
            test_app.dependency_overrides[verify_oauth_client_prod]

        # an endpoint using verify_oauth_client_prod
        async with AsyncClient(
            app=test_app, base_url="http://0.0.0.0:8080", follow_redirects=True
        ) as client:
            response = await client.get(V1_URL_PREFIX + "/system")
            assert response.status_code == 401

    @pytest.mark.asyncio
    async def test_configure_security_env_defaults_to_prod(self) -> None:
        """
        This test verifies that when env is not set, there are no
        dependency overrides for the oauth clients.
        """

        # simulates a config with default settings, not loading from any env variables
        default_security_settings = SecuritySettings()
        test_app = FastAPI(title="test")
        test_app = create_fides_app(
            lifespan=lifespan, security_env=default_security_settings.env
        )
        with pytest.raises(KeyError):
            test_app.dependency_overrides[verify_oauth_client]

        with pytest.raises(KeyError):
            test_app.dependency_overrides[verify_oauth_client_prod]

        # an endpoint using verify_oauth_client_prod
        async with AsyncClient(
            app=test_app, base_url="http://0.0.0.0:8080", follow_redirects=True
        ) as client:
            response = await client.get(V1_URL_PREFIX + "/system")
            assert response.status_code == 401
