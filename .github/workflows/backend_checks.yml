name: Backend Code Checks

on:
  pull_request:
  merge_group:
    types: [checks_requested]
  push:
    branches:
      - "main"
      - "release-**"

permissions:
  checks: write
  pull-requests: write

env:
  IMAGE: ethyca/fides:local
  DEFAULT_PYTHON_VERSION: "3.13.11"
  DOCKER_USER: ${{ secrets.DOCKER_USER }}
  DOCKER_RO_TOKEN: ${{ secrets.DOCKER_RO_TOKEN }}

jobs:
  ###############
  ## Prechecks ##
  ###############
  Check-Backend-Changes:
    runs-on: ubuntu-latest
    outputs:
      has_backend_changes: ${{ steps.filter.outputs.backend }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for backend file changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          list-files: shell
          filters: |
            backend:
              - '**/*.py'
              - '**/*.pxl'
              - 'Dockerfile'
              - 'Makefile'
              - 'pyproject.toml'
              - 'noxfile.py'
              - 'data/**'
              - '.github/workflows/backend_checks.yml'

      - name: Log changed files
        if: steps.filter.outputs.backend == 'true'
        run: echo "${{ steps.filter.outputs.backend_files }}"

  Collect-Tests:
    needs: Check-Backend-Changes
    if: needs.Check-Backend-Changes.outputs.has_backend_changes == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set Up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.DEFAULT_PYTHON_VERSION }}

      - name: Install dependencies and nox
        run: |
          uv venv
          uv pip install setuptools==80.10.2 wheel
          uv sync

      - name: Cache Nox virtual environment
        uses: actions/cache@v4
        with:
          path: .nox/
          key: ${{ runner.os }}-uv-nox-${{ github.job }}-${{ env.DEFAULT_PYTHON_VERSION }}-${{ hashFiles('noxfile.py') }}-${{ hashFiles('noxfiles/**.py') }}-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-uv-nox-${{ github.job }}-${{ env.DEFAULT_PYTHON_VERSION }}

      - name: Run Static Check
        run: uv run nox -s collect_tests

  Build-Frontend-Placeholder:
    needs: Check-Backend-Changes
    if: needs.Check-Backend-Changes.outputs.has_backend_changes == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Create placeholder admin-ui
        run: |
          mkdir -p admin-ui-out
          echo '<h1>Placeholder</h1>' > admin-ui-out/index.html

      - name: Upload admin-ui placeholder
        uses: actions/upload-artifact@v4
        with:
          name: admin-ui-build
          path: admin-ui-out/
          retention-days: 1

  Build:
    needs: [Check-Backend-Changes, Build-Frontend-Placeholder]
    if: needs.Check-Backend-Changes.outputs.has_backend_changes == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download admin-ui build
        uses: actions/download-artifact@v4
        with:
          name: admin-ui-build
          path: prebuilt/fides/clients/admin-ui/out

      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v3

      - name: Build container
        uses: docker/build-push-action@v6
        with:
          builder: ${{ steps.buildx.outputs.name }}
          context: .
          build-args: PYTHON_VERSION=${{ env.DEFAULT_PYTHON_VERSION }}
          build-contexts: |
            built_frontend=prebuilt
          target: test
          outputs: type=docker,dest=/tmp/python-${{ env.DEFAULT_PYTHON_VERSION }}.tar
          push: false
          tags: ${{ env.IMAGE }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Upload container
        uses: actions/upload-artifact@v4
        with:
          name: python-${{ env.DEFAULT_PYTHON_VERSION }}
          path: /tmp/python-${{ env.DEFAULT_PYTHON_VERSION }}.tar
          retention-days: 1

  #################
  ## Misc Checks ##
  #################
  Check-Container-Startup:
    needs: [Check-Backend-Changes, Build]
    if: needs.Check-Backend-Changes.outputs.has_backend_changes == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Pull Docker images in background
        run: |
          docker pull postgres:16 > /dev/null 2>&1 &
          docker pull redis:8.0-alpine > /dev/null 2>&1 &
          echo "Docker pull initiated in background."
        shell: bash

      - name: Download container
        uses: actions/download-artifact@v4
        with:
          name: python-${{ env.DEFAULT_PYTHON_VERSION }}
          path: /tmp/

      - name: Load image
        run: docker load --input /tmp/python-${{ env.DEFAULT_PYTHON_VERSION }}.tar

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set Up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.DEFAULT_PYTHON_VERSION }}

      - name: Install dependencies and nox
        run: |
          uv venv
          uv pip install setuptools==80.10.2 wheel
          uv sync

      - name: Cache Nox virtual environment
        uses: actions/cache@v4
        with:
          path: .nox/
          key: ${{ runner.os }}-uv-nox-${{ github.job }}-${{ env.DEFAULT_PYTHON_VERSION }}-${{ hashFiles('noxfile.py') }}-${{ hashFiles('noxfiles/**.py') }}-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-uv-nox-${{ github.job }}-${{ env.DEFAULT_PYTHON_VERSION }}-

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USER }}
          password: ${{ env.DOCKER_RO_TOKEN }}

      - name: Run Fides webserver startup check
        run: uv run nox -s check_container_startup

      - name: Run Celery worker startup check
        run: uv run nox -s check_worker_startup

  Migration-Checks:
    needs: [Check-Backend-Changes, Check-Container-Startup]
    if: needs.Check-Backend-Changes.outputs.has_backend_changes == 'true'
    strategy:
      matrix:
        test_selection:
          - "check_migrations"
          - "check_migration_downgrade"

    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: false
    steps:
      - name: Download container
        uses: actions/download-artifact@v4
        with:
          name: python-${{ env.DEFAULT_PYTHON_VERSION }}
          path: /tmp/

      - name: Load image
        run: docker load --input /tmp/python-${{ env.DEFAULT_PYTHON_VERSION }}.tar

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set Up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.DEFAULT_PYTHON_VERSION }}

      - name: Install dependencies and nox
        run: |
          uv venv
          uv pip install setuptools==80.10.2 wheel
          uv sync

      - name: Cache Nox virtual environment
        uses: actions/cache@v4
        with:
          path: .nox/
          key: ${{ runner.os }}-uv-nox-${{ github.job }}-${{ env.DEFAULT_PYTHON_VERSION }}-${{ hashFiles('noxfile.py') }}-${{ hashFiles('noxfiles/**.py') }}-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-uv-nox-${{ github.job }}-${{ env.DEFAULT_PYTHON_VERSION }}-

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USER }}
          password: ${{ env.DOCKER_RO_TOKEN }}

      - name: Run migration test
        run: uv run nox -s "${{ matrix.test_selection }}"

  Misc-Tests:
    needs: [Check-Backend-Changes, Check-Container-Startup]
    if: needs.Check-Backend-Changes.outputs.has_backend_changes == 'true'
    strategy:
      matrix:
        test_selection:
          - "check_fides_annotations"
          - "fides_db_scan"
          - "docs_check"
          - "minimal_config_startup"

    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: true
    steps:
      - name: Download container
        uses: actions/download-artifact@v4
        with:
          name: python-${{ env.DEFAULT_PYTHON_VERSION }}
          path: /tmp/

      - name: Load image
        run: docker load --input /tmp/python-${{ env.DEFAULT_PYTHON_VERSION }}.tar

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set Up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.DEFAULT_PYTHON_VERSION }}

      - name: Install dependencies and nox
        run: |
          uv venv
          uv pip install setuptools==80.10.2 wheel
          uv sync

      - name: Cache Nox virtual environment
        uses: actions/cache@v4
        with:
          path: .nox/
          key: ${{ runner.os }}-uv-nox-${{ github.job }}-${{ env.DEFAULT_PYTHON_VERSION }}-${{ hashFiles('noxfile.py') }}-${{ hashFiles('noxfiles/**.py') }}-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-uv-nox-${{ github.job }}-${{ env.DEFAULT_PYTHON_VERSION }}-qq

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USER }}
          password: ${{ env.DOCKER_RO_TOKEN }}

      - name: Run test suite
        run: uv run nox -s "${{ matrix.test_selection }}"

      - name: Publish Test Report
        uses: mikepenz/action-junit-report@v5
        if: success() || failure() # always run even if the previous step fails
        with:
          report_paths: "**/test_report.xml"

  ###########
  ## Tests ##
  ###########
  Fides-Tests:
    needs: [Check-Backend-Changes, Check-Container-Startup]
    if: needs.Check-Backend-Changes.outputs.has_backend_changes == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          # api - 8 splits
          - test_selection: "api"
            split_group: 1
          - test_selection: "api"
            split_group: 2
          - test_selection: "api"
            split_group: 3
          - test_selection: "api"
            split_group: 4
          - test_selection: "api"
            split_group: 5
          - test_selection: "api"
            split_group: 6
          - test_selection: "api"
            split_group: 7
          - test_selection: "api"
            split_group: 8
          # Non-sharded groups
          - test_selection: "cli"
            split_group: null
          - test_selection: "common"
            split_group: null
          - test_selection: "config"
            split_group: null
          - test_selection: "connectors"
            split_group: null
          - test_selection: "migration"
            split_group: null
          # service - 8 splits
          - test_selection: "service"
            split_group: 1
          - test_selection: "service"
            split_group: 2
          - test_selection: "service"
            split_group: 3
          - test_selection: "service"
            split_group: 4
          - test_selection: "service"
            split_group: 5
          - test_selection: "service"
            split_group: 6
          - test_selection: "service"
            split_group: 7
          - test_selection: "service"
            split_group: 8

    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Pull Docker images in background
        run: |
          docker pull postgres:16 > /dev/null 2>&1 &
          docker pull redis:8.0-alpine > /dev/null 2>&1 &
          echo "Docker pull initiated in background."
        shell: bash

      - name: Download container
        uses: actions/download-artifact@v4
        with:
          name: python-${{ env.DEFAULT_PYTHON_VERSION }}
          path: /tmp/

      - name: Load image
        run: docker load --input /tmp/python-${{ env.DEFAULT_PYTHON_VERSION }}.tar

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set Up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.DEFAULT_PYTHON_VERSION }}

      - name: Install dependencies and nox
        run: |
          uv venv
          uv pip install setuptools==80.10.2 wheel
          uv sync

      - name: Cache Nox virtual environment
        uses: actions/cache@v4
        with:
          path: .nox/
          key: ${{ runner.os }}-uv-nox-${{ github.job }}-${{ env.DEFAULT_PYTHON_VERSION }}-${{ matrix.test_selection }}-${{ matrix.split_group }}-${{ hashFiles('noxfile.py') }}-${{ hashFiles('noxfiles/**.py') }}-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-uv-nox-${{ github.job }}-${{ env.DEFAULT_PYTHON_VERSION }}-${{ matrix.test_selection }}-${{ matrix.split_group }}

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USER }}
          password: ${{ env.DOCKER_RO_TOKEN }}

      - name: Run test suite
        run: |
          if [ "${{ matrix.split_group }}" != "" ] && [ "${{ matrix.split_group }}" != "null" ]; then
            export TOTAL_SPLITS=8
            export SPLIT_GROUP=${{ matrix.split_group }}
          fi
          uv run nox -s "pytest(${{ matrix.test_selection }})"

      - name: Publish Test Report
        uses: mikepenz/action-junit-report@v5
        if: success() || failure()
        with:
          report_paths: "**/test_report.xml"

      - name: Upload coverage
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

  # Summary job for branch protection - passes if all jobs pass or are skipped
  Backend-Checks-Summary:
    runs-on: ubuntu-latest
    if: always()
    needs:
      - Collect-Tests
      - Build
      - Check-Container-Startup
      - Migration-Checks
      - Misc-Tests
      - Fides-Tests
    steps:
      - name: Check job results
        run: |
          echo "Collect-Tests: ${{ needs.Collect-Tests.result }}"
          echo "Build: ${{ needs.Build.result }}"
          echo "Check-Container-Startup: ${{ needs.Check-Container-Startup.result }}"
          echo "Migration-Checks: ${{ needs.Migration-Checks.result }}"
          echo "Misc-Tests: ${{ needs.Misc-Tests.result }}"
          echo "Fides-Tests: ${{ needs.Fides-Tests.result }}"

          # Fail only if jobs failed (not if skipped)
          if [ "${{ needs.Collect-Tests.result }}" == "failure" ] || \
             [ "${{ needs.Build.result }}" == "failure" ] || \
             [ "${{ needs.Check-Container-Startup.result }}" == "failure" ] || \
             [ "${{ needs.Migration-Checks.result }}" == "failure" ] || \
             [ "${{ needs.Misc-Tests.result }}" == "failure" ] || \
             [ "${{ needs.Fides-Tests.result }}" == "failure" ]; then
            echo "❌ One or more required jobs failed"
            exit 1
          fi

          # Check for cancelled jobs (treat as failure)
          if [ "${{ needs.Collect-Tests.result }}" == "cancelled" ] || \
             [ "${{ needs.Build.result }}" == "cancelled" ] || \
             [ "${{ needs.Check-Container-Startup.result }}" == "cancelled" ] || \
             [ "${{ needs.Migration-Checks.result }}" == "cancelled" ] || \
             [ "${{ needs.Misc-Tests.result }}" == "cancelled" ] || \
             [ "${{ needs.Fides-Tests.result }}" == "cancelled" ]; then
            echo "❌ One or more required jobs were cancelled"
            exit 1
          fi

          echo "✅ All required backend checks passed or were skipped"
