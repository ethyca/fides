name: Backend Code Checks

on:
  pull_request:
  merge_group:
    types: [checks_requested]
  push:
    branches:
      - "main"
      - "release-**"

permissions:
  checks: write
  pull-requests: write

env:
  IMAGE: ethyca/fides:local
  DEFAULT_PYTHON_VERSION: "3.13.11"
  DOCKER_USER: ${{ secrets.DOCKER_USER }}
  DOCKER_RO_TOKEN: ${{ secrets.DOCKER_RO_TOKEN }}
  SAAS_OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.SAAS_OP_SERVICE_ACCOUNT_TOKEN }}
  SAAS_SECRETS_OP_VAULT_ID: ${{ secrets.SAAS_SECRETS_OP_VAULT_ID }}

jobs:
  ###############
  ## Prechecks ##
  ###############
  Check-Backend-Changes:
    runs-on: ubuntu-latest
    outputs:
      has_backend_changes: ${{ steps.filter.outputs.backend }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for backend file changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          list-files: shell
          filters: |
            backend:
              - '**/*.py'
              - '**/*.pxl'
              - 'Dockerfile'
              - 'Makefile'
              - 'pyproject.toml'
              - 'noxfile.py'
              - 'data/**'
              - '.github/workflows/backend_checks.yml'

      - name: Log changed files
        if: steps.filter.outputs.backend == 'true'
        run: echo "${{ steps.filter.outputs.backend_files }}"

  Collect-Tests:
    needs: Check-Backend-Changes
    if: needs.Check-Backend-Changes.outputs.has_backend_changes == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup backend
        uses: ./.github/actions/setup-backend
        with:
          python-version: ${{ env.DEFAULT_PYTHON_VERSION }}
          cache-key-suffix: collect-tests

      - name: Collect tests
        run: uv run nox -s collect_tests

  Build-Frontend-Placeholder:
    needs: Check-Backend-Changes
    if: needs.Check-Backend-Changes.outputs.has_backend_changes == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Create placeholder admin-ui
        run: |
          mkdir -p admin-ui-out
          echo '<h1>Placeholder</h1>' > admin-ui-out/index.html

      - name: Upload admin-ui placeholder
        uses: actions/upload-artifact@v4
        with:
          name: admin-ui-build
          path: admin-ui-out/
          retention-days: 1

  Build:
    needs: [Check-Backend-Changes, Build-Frontend-Placeholder]
    if: needs.Check-Backend-Changes.outputs.has_backend_changes == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download admin-ui build
        uses: actions/download-artifact@v4
        with:
          name: admin-ui-build
          path: prebuilt/fides/clients/admin-ui/out

      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v3

      - name: Build container
        uses: docker/build-push-action@v6
        with:
          builder: ${{ steps.buildx.outputs.name }}
          context: .
          build-args: PYTHON_VERSION=${{ env.DEFAULT_PYTHON_VERSION }}
          build-contexts: |
            built_frontend=prebuilt
          target: test
          outputs: type=docker,dest=/tmp/python-${{ env.DEFAULT_PYTHON_VERSION }}.tar
          push: false
          tags: ${{ env.IMAGE }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Upload container
        uses: actions/upload-artifact@v4
        with:
          name: python-${{ env.DEFAULT_PYTHON_VERSION }}
          path: /tmp/python-${{ env.DEFAULT_PYTHON_VERSION }}.tar
          retention-days: 1

  #################
  ## Misc Checks ##
  #################
  Check-Container-Startup:
    needs: [Check-Backend-Changes, Build]
    if: needs.Check-Backend-Changes.outputs.has_backend_changes == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Pull Docker images in background
        run: |
          docker pull postgres:16 > /dev/null 2>&1 &
          docker pull redis:8.0-alpine > /dev/null 2>&1 &

      - name: Download container
        uses: actions/download-artifact@v4
        with:
          name: python-${{ env.DEFAULT_PYTHON_VERSION }}
          path: /tmp/

      - name: Load image
        run: docker load --input /tmp/python-${{ env.DEFAULT_PYTHON_VERSION }}.tar

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup backend
        uses: ./.github/actions/setup-backend
        with:
          python-version: ${{ env.DEFAULT_PYTHON_VERSION }}
          cache-key-suffix: container-startup

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USER }}
          password: ${{ env.DOCKER_RO_TOKEN }}

      - name: Run Fides webserver startup check
        run: uv run nox -s check_container_startup

      - name: Run Celery worker startup check
        run: uv run nox -s check_worker_startup

  Migration-Checks:
    needs: [Check-Backend-Changes, Check-Container-Startup]
    if: needs.Check-Backend-Changes.outputs.has_backend_changes == 'true'
    strategy:
      matrix:
        test_selection:
          - "check_migrations"
          - "check_migration_downgrade"

    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: false
    steps:
      - name: Download container
        uses: actions/download-artifact@v4
        with:
          name: python-${{ env.DEFAULT_PYTHON_VERSION }}
          path: /tmp/

      - name: Load image
        run: docker load --input /tmp/python-${{ env.DEFAULT_PYTHON_VERSION }}.tar

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup backend
        uses: ./.github/actions/setup-backend
        with:
          python-version: ${{ env.DEFAULT_PYTHON_VERSION }}
          cache-key-suffix: migration-${{ matrix.test_selection }}

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USER }}
          password: ${{ env.DOCKER_RO_TOKEN }}

      - name: Run migration test
        run: uv run nox -s "${{ matrix.test_selection }}"

  Misc-Tests:
    needs: [Check-Backend-Changes, Check-Container-Startup]
    if: needs.Check-Backend-Changes.outputs.has_backend_changes == 'true'
    strategy:
      matrix:
        test_selection:
          - "check_fides_annotations"
          - "fides_db_scan"
          - "docs_check"
          - "minimal_config_startup"

    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: true
    steps:
      - name: Download container
        uses: actions/download-artifact@v4
        with:
          name: python-${{ env.DEFAULT_PYTHON_VERSION }}
          path: /tmp/

      - name: Load image
        run: docker load --input /tmp/python-${{ env.DEFAULT_PYTHON_VERSION }}.tar

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup backend
        uses: ./.github/actions/setup-backend
        with:
          python-version: ${{ env.DEFAULT_PYTHON_VERSION }}
          cache-key-suffix: misc-${{ matrix.test_selection }}

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USER }}
          password: ${{ env.DOCKER_RO_TOKEN }}

      - name: Run test suite
        run: uv run nox -s "${{ matrix.test_selection }}"

      - name: Publish Test Report
        uses: mikepenz/action-junit-report@v5
        if: success() || failure()
        with:
          report_paths: "**/test_report.xml"

  ################
  ## Safe Tests ##
  ################
  Safe-Tests:
    needs: Check-Backend-Changes
    if: needs.Check-Backend-Changes.outputs.has_backend_changes == 'true'
    strategy:
      fail-fast: false
      matrix:
        test_selection:
          - "ctl-not-external"
          - "ops-unit-api"
          - "ops-unit-non-api"
          - "api"
          - "lib"
          - "misc-unit"
          - "misc-integration"

    runs-on: ubuntu-latest
    timeout-minutes: 20
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: fides
          POSTGRES_DB: fides
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      postgres-example:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres_example
        ports:
          - 6432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:8.0-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup backend
        uses: ./.github/actions/setup-backend
        with:
          python-version: ${{ env.DEFAULT_PYTHON_VERSION }}
          cache-key-suffix: safe-native-${{ matrix.test_selection }}

      - name: Create test databases
        run: |
          PGPASSWORD=fides psql -h localhost -U postgres -c "CREATE DATABASE fides_test;" || true
          for i in $(seq 0 7); do
            PGPASSWORD=fides psql -h localhost -U postgres -c "CREATE DATABASE fides_test_gw${i};" || true
          done

      - name: Run test suite (native, no Docker)
        env:
          FIDES__CONFIG_PATH: tests/ci_native_test_config.toml
          FIDES__TEST_MODE: "true"
          FIDES__DEV_MODE: "true"
          POSTGRES_EXAMPLE_HOST: localhost
          POSTGRES_EXAMPLE_PORT: "6432"
        run: uv run nox -s "pytest_native(${{ matrix.test_selection }})"

      - name: Publish Test Report
        uses: mikepenz/action-junit-report@v5
        if: success() || failure()
        with:
          report_paths: "**/test_report.xml"

      - name: Upload coverage
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

  #####################################
  ## Docker-Based Integration Tests  ##
  #####################################
  Ops-Integration:
    needs: [Check-Backend-Changes, Check-Container-Startup]
    if: needs.Check-Backend-Changes.outputs.has_backend_changes == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Pull Docker images in background
        run: |
          docker pull postgres:16 > /dev/null 2>&1 &
          docker pull redis:8.0-alpine > /dev/null 2>&1 &

      - name: Download container
        uses: actions/download-artifact@v4
        with:
          name: python-${{ env.DEFAULT_PYTHON_VERSION }}
          path: /tmp/

      - name: Load image
        run: docker load --input /tmp/python-${{ env.DEFAULT_PYTHON_VERSION }}.tar

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup backend
        uses: ./.github/actions/setup-backend
        with:
          python-version: ${{ env.DEFAULT_PYTHON_VERSION }}
          cache-key-suffix: ops-integration

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USER }}
          password: ${{ env.DOCKER_RO_TOKEN }}

      - name: Run test suite
        run: uv run nox -s "pytest(ops-integration)"

      - name: Publish Test Report
        uses: mikepenz/action-junit-report@v5
        if: success() || failure()
        with:
          report_paths: "**/test_report.xml"

  ##################
  ## Unsafe Tests ##
  ##################
  Pytest-Ctl-External:
    needs: [Check-Backend-Changes, Check-Container-Startup]
    if: needs.Check-Backend-Changes.outputs.has_backend_changes == 'true' && (contains(github.event.pull_request.labels.*.name, 'run unsafe ci checks') || github.event_name == 'push' || github.event_name == 'merge_group')
    strategy:
      max-parallel: 1
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Download container
        uses: actions/download-artifact@v4
        with:
          name: python-${{ env.DEFAULT_PYTHON_VERSION }}
          path: /tmp/

      - name: Load image
        run: docker load --input /tmp/python-${{ env.DEFAULT_PYTHON_VERSION }}.tar

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup backend
        uses: ./.github/actions/setup-backend
        with:
          python-version: ${{ env.DEFAULT_PYTHON_VERSION }}
          cache-key-suffix: ctl-external

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USER }}
          password: ${{ env.DOCKER_RO_TOKEN }}

      - name: Load secrets from 1Password
        uses: 1password/load-secrets-action@v2
        with:
          export-env: true
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          AWS_ACCESS_KEY_ID: op://github-actions/ctl/AWS_ACCESS_KEY_ID
          AWS_DEFAULT_REGION: op://github-actions/ctl/AWS_DEFAULT_REGION
          AWS_SECRET_ACCESS_KEY: op://github-actions/ctl/AWS_SECRET_ACCESS_KEY
          DYNAMODB_ACCESS_KEY_ID: op://github-actions/dynamodb/DYNAMODB_ACCESS_KEY_ID
          DYNAMODB_ACCESS_KEY: op://github-actions/dynamodb/DYNAMODB_ACCESS_KEY
          DYNAMODB_REGION: op://github-actions/dynamodb/DYNAMODB_REGION
          OKTA_CLIENT_ID: op://github-actions/okta/OKTA_CLIENT_ID
          OKTA_PRIVATE_KEY: op://github-actions/okta/OKTA_PRIVATE_KEY
          REDSHIFT_FIDESCTL_PASSWORD: op://github-actions/ctl/REDSHIFT_FIDESCTL_PASSWORD
          SNOWFLAKE_FIDESCTL_PASSWORD: op://github-actions/ctl/SNOWFLAKE_FIDESCTL_PASSWORD

      - name: Run external test suite
        run: uv run nox -s "pytest(ctl-external)"
        env:
          BIGQUERY_CONFIG: ${{ secrets.BIGQUERY_CONFIG }}

  External-Datastores:
    needs: [Check-Backend-Changes, Check-Container-Startup]
    if: needs.Check-Backend-Changes.outputs.has_backend_changes == 'true' && (contains(github.event.pull_request.labels.*.name, 'run unsafe ci checks') || github.event_name == 'push' || github.event_name == 'merge_group')
    strategy:
      max-parallel: 1
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Download container
        uses: actions/download-artifact@v4
        with:
          name: python-${{ env.DEFAULT_PYTHON_VERSION }}
          path: /tmp/

      - name: Load image
        run: docker load --input /tmp/python-${{ env.DEFAULT_PYTHON_VERSION }}.tar

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup backend
        uses: ./.github/actions/setup-backend
        with:
          python-version: ${{ env.DEFAULT_PYTHON_VERSION }}
          cache-key-suffix: external-datastores

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USER }}
          password: ${{ env.DOCKER_RO_TOKEN }}

      - name: Load secrets from 1Password
        uses: 1password/load-secrets-action@v2
        with:
          export-env: true
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          BIGQUERY_DATASET: op://github-actions/bigquery/BIGQUERY_DATASET
          BIGQUERY_KEYFILE_CREDS: op://github-actions/bigquery/BIGQUERY_KEYFILE_CREDS
          BIGQUERY_ENTERPRISE_DATASET: op://github-actions/bigquery-enterprise/BIGQUERY_ENTERPRISE_DATASET
          BIGQUERY_ENTERPRISE_KEYFILE_CREDS: op://github-actions/bigquery-enterprise/BIGQUERY_ENTERPRISE_KEYFILE_CREDS
          DYNAMODB_ACCESS_KEY_ID: op://github-actions/dynamodb/DYNAMODB_ACCESS_KEY_ID
          DYNAMODB_ACCESS_KEY: op://github-actions/dynamodb/DYNAMODB_ACCESS_KEY
          DYNAMODB_ASSUME_ROLE_ARN: op://github-actions/dynamodb/DYNAMODB_ASSUME_ROLE_ARN
          DYNAMODB_REGION: op://github-actions/dynamodb/DYNAMODB_REGION
          GOOGLE_CLOUD_SQL_MYSQL_DATABASE_NAME: op://github-actions/gcp-mysql/GOOGLE_CLOUD_SQL_MYSQL_DATABASE_NAME
          GOOGLE_CLOUD_SQL_MYSQL_DB_IAM_USER: op://github-actions/gcp-mysql/GOOGLE_CLOUD_SQL_MYSQL_DB_IAM_USER
          GOOGLE_CLOUD_SQL_MYSQL_INSTANCE_CONNECTION_NAME: op://github-actions/gcp-mysql/GOOGLE_CLOUD_SQL_MYSQL_INSTANCE_CONNECTION_NAME
          GOOGLE_CLOUD_SQL_MYSQL_KEYFILE_CREDS: op://github-actions/gcp-mysql/GOOGLE_CLOUD_SQL_MYSQL_KEYFILE_CREDS
          GOOGLE_CLOUD_SQL_POSTGRES_DATABASE_NAME: op://github-actions/gcp-postgres/GOOGLE_CLOUD_SQL_POSTGRES_DATABASE_NAME
          GOOGLE_CLOUD_SQL_POSTGRES_DATABASE_SCHEMA_NAME: op://github-actions/gcp-postgres/GOOGLE_CLOUD_SQL_POSTGRES_DATABASE_SCHEMA_NAME
          GOOGLE_CLOUD_SQL_POSTGRES_DB_IAM_USER: op://github-actions/gcp-postgres/GOOGLE_CLOUD_SQL_POSTGRES_DB_IAM_USER
          GOOGLE_CLOUD_SQL_POSTGRES_INSTANCE_CONNECTION_NAME: op://github-actions/gcp-postgres/GOOGLE_CLOUD_SQL_POSTGRES_INSTANCE_CONNECTION_NAME
          GOOGLE_CLOUD_SQL_POSTGRES_KEYFILE_CREDS: op://github-actions/gcp-postgres/GOOGLE_CLOUD_SQL_POSTGRES_KEYFILE_CREDS
          OKTA_CLIENT_ID: op://github-actions/okta/OKTA_CLIENT_ID
          OKTA_ORG_URL: op://github-actions/okta/OKTA_ORG_URL
          OKTA_PRIVATE_KEY: op://github-actions/okta/OKTA_PRIVATE_KEY
          RDS_MYSQL_AWS_ACCESS_KEY_ID: op://github-actions/rds-mysql/RDS_MYSQL_AWS_ACCESS_KEY_ID
          RDS_MYSQL_AWS_SECRET_ACCESS_KEY: op://github-actions/rds-mysql/RDS_MYSQL_AWS_SECRET_ACCESS_KEY
          RDS_MYSQL_DB_INSTANCE: op://github-actions/rds-mysql/RDS_MYSQL_DB_INSTANCE
          RDS_MYSQL_DB_NAME: op://github-actions/rds-mysql/RDS_MYSQL_DB_NAME
          RDS_MYSQL_DB_USERNAME: op://github-actions/rds-mysql/RDS_MYSQL_DB_USERNAME
          RDS_MYSQL_REGION: op://github-actions/rds-mysql/RDS_MYSQL_REGION
          RDS_POSTGRES_AWS_ACCESS_KEY_ID: op://github-actions/rds-postgres/RDS_POSTGRES_AWS_ACCESS_KEY_ID
          RDS_POSTGRES_AWS_SECRET_ACCESS_KEY: op://github-actions/rds-postgres/RDS_POSTGRES_AWS_SECRET_ACCESS_KEY
          RDS_POSTGRES_DB_USERNAME: op://github-actions/rds-postgres/RDS_POSTGRES_DB_USERNAME
          RDS_POSTGRES_REGION: op://github-actions/rds-postgres/RDS_POSTGRES_REGION
          REDSHIFT_TEST_DATABASE: op://github-actions/redshift/REDSHIFT_TEST_DATABASE
          REDSHIFT_TEST_DB_SCHEMA: op://github-actions/redshift/REDSHIFT_TEST_DB_SCHEMA
          REDSHIFT_TEST_HOST: op://github-actions/redshift/REDSHIFT_TEST_HOST
          REDSHIFT_TEST_PASSWORD: op://github-actions/redshift/REDSHIFT_TEST_PASSWORD
          REDSHIFT_TEST_PORT: op://github-actions/redshift/REDSHIFT_TEST_PORT
          REDSHIFT_TEST_USER: op://github-actions/redshift/REDSHIFT_TEST_USER
          SNOWFLAKE_TEST_ACCOUNT_IDENTIFIER: op://github-actions/snowflake/SNOWFLAKE_TEST_ACCOUNT_IDENTIFIER
          SNOWFLAKE_TEST_DATABASE_NAME: op://github-actions/snowflake/SNOWFLAKE_TEST_DATABASE_NAME
          SNOWFLAKE_TEST_PASSWORD: op://github-actions/snowflake/SNOWFLAKE_TEST_PASSWORD
          SNOWFLAKE_TEST_PRIVATE_KEY_PASSPHRASE: op://github-actions/snowflake/SNOWFLAKE_TEST_PRIVATE_KEY_PASSPHRASE
          SNOWFLAKE_TEST_PRIVATE_KEY: op://github-actions/snowflake/SNOWFLAKE_TEST_PRIVATE_KEY
          SNOWFLAKE_TEST_SCHEMA_NAME: op://github-actions/snowflake/SNOWFLAKE_TEST_SCHEMA_NAME
          SNOWFLAKE_TEST_USER_LOGIN_NAME: op://github-actions/snowflake/SNOWFLAKE_TEST_USER_LOGIN_NAME
          SNOWFLAKE_TEST_WAREHOUSE_NAME: op://github-actions/snowflake/SNOWFLAKE_TEST_WAREHOUSE_NAME
          S3_AWS_ACCESS_KEY_ID: op://github-actions/s3/S3_AWS_ACCESS_KEY_ID
          S3_AWS_SECRET_ACCESS_KEY: op://github-actions/s3/S3_AWS_SECRET_ACCESS_KEY
          MONGODB_ATLAS_HOST: op://github-actions/mongodb-atlas/MONGODB_ATLAS_HOST
          MONGODB_ATLAS_USERNAME: op://github-actions/mongodb-atlas/MONGODB_ATLAS_USERNAME
          MONGODB_ATLAS_PASSWORD: op://github-actions/mongodb-atlas/MONGODB_ATLAS_PASSWORD
          MONGODB_ATLAS_DEFAULT_AUTH_DB: op://github-actions/mongodb-atlas/MONGODB_ATLAS_DEFAULT_AUTH_DB
          MONGODB_ATLAS_USE_SRV: op://github-actions/mongodb-atlas/MONGODB_ATLAS_USE_SRV
          MONGODB_ATLAS_SSL_ENABLED: op://github-actions/mongodb-atlas/MONGODB_ATLAS_SSL_ENABLED

      - name: Integration Tests (Misc)
        run: uv run nox -s "pytest(misc-integration-external)"

      - name: Integration Tests (External)
        run: uv run nox -s "pytest(ops-external-datastores)"

  External-SaaS-Connectors:
    needs: [Check-Backend-Changes, Check-Container-Startup]
    if: needs.Check-Backend-Changes.outputs.has_backend_changes == 'true' && (contains(github.event.pull_request.labels.*.name, 'run unsafe ci checks') || github.event_name == 'push' || github.event_name == 'merge_group')
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      id-token: write
    strategy:
      max-parallel: 1
    steps:
      - name: Download container
        uses: actions/download-artifact@v4
        with:
          name: python-${{ env.DEFAULT_PYTHON_VERSION }}
          path: /tmp/

      - name: Load image
        run: docker load --input /tmp/python-${{ env.DEFAULT_PYTHON_VERSION }}.tar

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup backend
        uses: ./.github/actions/setup-backend
        with:
          python-version: ${{ env.DEFAULT_PYTHON_VERSION }}
          cache-key-suffix: saas-connectors

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USER }}
          password: ${{ env.DOCKER_RO_TOKEN }}

      - name: SaaS Connector Tests
        env:
          SAAS_OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.SAAS_OP_SERVICE_ACCOUNT_TOKEN }}
          SAAS_SECRETS_OP_VAULT_ID: ${{ secrets.SAAS_SECRETS_OP_VAULT_ID }}
        run: uv run nox -s "pytest(ops-saas)"

  Backend-Checks-Summary:
    runs-on: ubuntu-latest
    if: always()
    needs:
      - Collect-Tests
      - Build
      - Check-Container-Startup
      - Migration-Checks
      - Misc-Tests
      - Safe-Tests
      - Ops-Integration
    steps:
      - name: Check job results
        run: |
          echo "Collect-Tests: ${{ needs.Collect-Tests.result }}"
          echo "Build: ${{ needs.Build.result }}"
          echo "Check-Container-Startup: ${{ needs.Check-Container-Startup.result }}"
          echo "Migration-Checks: ${{ needs.Migration-Checks.result }}"
          echo "Misc-Tests: ${{ needs.Misc-Tests.result }}"
          echo "Safe-Tests: ${{ needs.Safe-Tests.result }}"
          echo "Ops-Integration: ${{ needs.Ops-Integration.result }}"

          if [ "${{ needs.Collect-Tests.result }}" == "failure" ] || \
             [ "${{ needs.Build.result }}" == "failure" ] || \
             [ "${{ needs.Check-Container-Startup.result }}" == "failure" ] || \
             [ "${{ needs.Migration-Checks.result }}" == "failure" ] || \
             [ "${{ needs.Misc-Tests.result }}" == "failure" ] || \
             [ "${{ needs.Safe-Tests.result }}" == "failure" ] || \
             [ "${{ needs.Ops-Integration.result }}" == "failure" ]; then
            echo "One or more required jobs failed"
            exit 1
          fi

          if [ "${{ needs.Collect-Tests.result }}" == "cancelled" ] || \
             [ "${{ needs.Build.result }}" == "cancelled" ] || \
             [ "${{ needs.Check-Container-Startup.result }}" == "cancelled" ] || \
             [ "${{ needs.Migration-Checks.result }}" == "cancelled" ] || \
             [ "${{ needs.Misc-Tests.result }}" == "cancelled" ] || \
             [ "${{ needs.Safe-Tests.result }}" == "cancelled" ] || \
             [ "${{ needs.Ops-Integration.result }}" == "cancelled" ]; then
            echo "One or more required jobs were cancelled"
            exit 1
          fi

          echo "All required backend checks passed or were skipped"
