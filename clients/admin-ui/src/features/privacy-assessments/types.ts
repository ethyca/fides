import type {
  AssessmentResponse as GeneratedAssessmentResponse,
  CreateAssessmentRequest,
  Page_AssessmentResponse_,
  TemplateResponse,
} from "~/types/api";

export enum RiskLevel {
  HIGH = "high",
  MEDIUM = "medium",
  LOW = "low",
}

export enum AssessmentStatus {
  IN_PROGRESS = "in_progress",
  COMPLETED = "completed",
  OUTDATED = "outdated",
}

export enum AnswerStatus {
  COMPLETE = "complete",
  PARTIAL = "partial",
  NEEDS_INPUT = "needs_input",
}

export enum AnswerSource {
  SYSTEM = "system",
  AI_ANALYSIS = "ai_analysis",
  USER_INPUT = "user_input",
  SLACK = "slack",
}

export enum EvidenceType {
  SYSTEM = "system",
  AI_ANALYSIS = "ai_analysis",
  MANUAL_ENTRY = "manual_entry",
  SLACK_COMMUNICATION = "slack_communication",
}

// Override autogenerated types with specific status and risk_level types
export interface PrivacyAssessmentResponse
  extends Omit<GeneratedAssessmentResponse, "status" | "risk_level"> {
  status: AssessmentStatus;
  risk_level: RiskLevel | null;
}

// Override Page type with our strongly-typed assessment
// eslint-disable-next-line @typescript-eslint/naming-convention
export interface Page_PrivacyAssessmentResponse_
  extends Omit<Page_AssessmentResponse_, "items"> {
  items: PrivacyAssessmentResponse[];
}

// Re-export request and template types directly
export type { CreateAssessmentRequest, TemplateResponse };

export interface PrivacyAssessmentDetailResponse
  extends PrivacyAssessmentResponse {
  assessment_type: string;
  question_groups: QuestionGroup[];
  questionnaire: QuestionnaireStatus | null;
  metadata: AssessmentMetadata | null;
}

export interface AssessmentMetadata {
  generation_timestamp: string;
  model_used: string | null;
  use_llm: boolean;
  [key: string]: unknown;
}

export interface QuestionGroup {
  id: string;
  title: string;
  requirement_key: string;
  questions: AssessmentQuestion[];
  answered_count: number;
  total_count: number;
  risk_level: RiskLevel | null;
  last_updated_at: string | null;
  last_updated_by: string | null;
}

export interface AssessmentQuestion {
  id: string;
  question_id: string;
  question_text: string;
  guidance: string | null;
  required: boolean;
  fides_sources: string[];
  expected_coverage: string;
  answer_text: string;
  answer_status: AnswerStatus;
  answer_source: AnswerSource;
  confidence: number | null;
  evidence: EvidenceItem[];
  missing_data: string[];
  sme_prompt: string | null;
}

// Discriminated union for different evidence types
export type EvidenceItem =
  | SystemEvidenceItem
  | AIAnalysisEvidenceItem
  | ManualEntryEvidenceItem
  | SlackCommunicationEvidenceItem;

export interface BaseEvidenceItem {
  id: string;
  created_at: string;
  citation_number: number | null;
}

export interface SystemEvidenceItem extends BaseEvidenceItem {
  type: EvidenceType.SYSTEM;
  source: {
    source_type: SystemSourceType;
    source_key: string;
    source_name: string;
  };
  field: {
    field_name: string;
    field_label: string;
  };
  value: unknown;
  value_display: string;
}

export type SystemSourceType =
  | "system"
  | "privacy_declaration"
  | "data_category"
  | "data_use"
  | "data_subject"
  | "dataset"
  | "data_flow";

export interface AIAnalysisEvidenceItem extends BaseEvidenceItem {
  type: EvidenceType.AI_ANALYSIS;
  model: {
    model_id: string;
    model_version: string | null;
  };
  analysis: {
    input_summary: string;
    reasoning: string | null;
    confidence: number;
    confidence_label: "high" | "medium" | "low";
  };
  sources_used: string[];
}

export interface ManualEntryEvidenceItem extends BaseEvidenceItem {
  type: EvidenceType.MANUAL_ENTRY;
  author: {
    user_id: string;
    user_name: string;
    user_email: string | null;
    role: string | null;
  };
  entry: {
    previous_value: string | null;
    new_value: string;
    edit_reason: string | null;
  };
}

export interface SlackCommunicationEvidenceItem extends BaseEvidenceItem {
  type: EvidenceType.SLACK_COMMUNICATION;
  channel: {
    channel_id: string;
    channel_name: string;
  };
  thread: {
    thread_id: string;
    thread_url: string | null;
    started_at: string;
    message_count: number;
    participant_count: number;
  };
  messages: SlackMessage[];
  summary: string | null;
}

export interface SlackMessage {
  message_id: string;
  timestamp: string;
  sender: {
    user_id: string;
    user_name: string;
    display_name: string;
    avatar_url: string | null;
  };
  content: {
    text: string;
    is_bot_message: boolean;
    attachments: SlackAttachment[];
  };
  reactions: SlackReaction[];
  reply_to_message_id: string | null;
}

export interface SlackAttachment {
  type: "file" | "image" | "link";
  name: string;
  url: string | null;
}

export interface SlackReaction {
  emoji: string;
  count: number;
  users: string[];
}

export interface QuestionnaireStatus {
  sent_at: string;
  channel: string;
  total_questions: number;
  answered_questions: number;
  last_reminder_at: string | null;
  reminder_count: number;
}

export interface QuestionnaireStatusResponse {
  assessment_id: string;
  sent_at: string;
  channel: string;
  total_questions: number;
  answered_questions: number;
  pending_questions: number;
  progress_percentage: number;
  questions: QuestionnaireQuestion[];
  last_reminder_at: string | null;
  reminder_count: number;
}

export interface QuestionnaireQuestion {
  question_id: string;
  question_text: string;
  status: "answered" | "pending";
  answered_at: string | null;
  answered_by: string | null;
}

export interface QuestionnaireResponse {
  sent_at: string;
  channel: string;
  questions_sent: number;
  message_id: string | null;
}

export interface ReminderResponse {
  sent_at: string;
  channel: string;
  pending_questions: number;
  message_id: string | null;
}

export interface CreatePrivacyAssessmentResponse {
  assessments: PrivacyAssessmentResponse[];
  assessment_type: string;
  assessment_name: string;
  total_created: number;
}

export interface UpdatePrivacyAssessmentRequest {
  name?: string;
  status?: AssessmentStatus;
  risk_level?: RiskLevel;
}

export interface UpdateAnswerRequest {
  answer_text: string;
}

export interface UpdateAnswerResponse {
  question: AssessmentQuestion;
  completeness: number;
  status: AssessmentStatus;
}

export interface BulkUpdateAnswersRequest {
  answers: AnswerUpdate[];
}

export interface AnswerUpdate {
  question_id: string;
  answer_text: string;
}

export interface BulkUpdateAnswersResponse {
  updated_count: number;
  completeness: number;
  status: AssessmentStatus;
  questions: AssessmentQuestion[];
}

export interface CreateQuestionnaireRequest {
  channel: string;
  message?: string;
  include_question_ids?: string[];
}

export interface CreateReminderRequest {
  message?: string;
}

export interface AssessmentEvidenceResponse {
  assessment_id: string;
  total_count: number;
  by_question?: Record<string, QuestionEvidence>;
  by_type?: {
    [EvidenceType.SYSTEM]: SystemEvidenceItem[];
    [EvidenceType.AI_ANALYSIS]: AIAnalysisEvidenceItem[];
    [EvidenceType.MANUAL_ENTRY]: ManualEntryEvidenceItem[];
    [EvidenceType.SLACK_COMMUNICATION]: SlackCommunicationEvidenceItem[];
  };
  items?: EvidenceItem[];
}

export interface QuestionEvidence {
  question_id: string;
  question_text: string;
  evidence: EvidenceItem[];
}

export interface GetPrivacyAssessmentsParams {
  page?: number;
  size?: number;
  status?: AssessmentStatus;
}

export interface GetAssessmentEvidenceParams {
  id: string;
  question_id?: string;
  type?: EvidenceType;
  group_by?: "question" | "type";
}
