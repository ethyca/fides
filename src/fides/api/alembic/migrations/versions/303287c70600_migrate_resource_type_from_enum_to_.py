"""migrate resource type from enum to string to account for custom taxonomies

Revision ID: 303287c70600
Revises: 56fe6fad2d89
Create Date: 2025-10-22 15:31:12.980243

"""

import sqlalchemy as sa
from alembic import op
from loguru import logger

# revision identifiers, used by Alembic.
revision = "303287c70600"
down_revision = "56fe6fad2d89"
branch_labels = None
depends_on = None

# Original enum values used by ResourceTypes
RESOURCE_TYPES = (
    "system",
    "data use",
    "data category",
    "data subject",
    "privacy declaration",
)

# Name for the PostgreSQL enum type that backs ResourceTypes
PG_ENUM_NAME = "resourcetypes"


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    # Drop unique functional index that references resource_type
    op.drop_index(
        "ix_plus_custom_field_definition_unique_lowername_resourcetype",
        table_name="plus_custom_field_definition",
    )

    # Alter resource_type columns from Enum -> String
    # Use a PostgreSQL USING clause to safely cast enum -> text
    op.alter_column(
        "plus_custom_field_definition",
        "resource_type",
        existing_type=sa.Enum(*RESOURCE_TYPES, name=PG_ENUM_NAME),
        type_=sa.String(),
        postgresql_using="resource_type::text",
        nullable=False,
    )
    op.alter_column(
        "plus_custom_field",
        "resource_type",
        existing_type=sa.Enum(*RESOURCE_TYPES, name=PG_ENUM_NAME),
        type_=sa.String(),
        postgresql_using="resource_type::text",
        nullable=False,
    )

    # Data migration: Convert old enum value 'privacy_declaration' to 'privacy declaration'
    # The old PostgreSQL enum used 'privacy_declaration' (with underscore) but the Python
    # ResourceTypes enum expects 'privacy declaration' (with space)
    op.execute(
        """
        UPDATE plus_custom_field_definition
        SET resource_type = 'privacy declaration'
        WHERE resource_type = 'privacy_declaration'
        """
    )
    op.execute(
        """
        UPDATE plus_custom_field
        SET resource_type = 'privacy declaration'
        WHERE resource_type = 'privacy_declaration'
        """
    )

    # Recreate unique functional index on (resource_type, lower(name))
    # Note: Use a raw expression for lower(name)
    op.create_index(
        "ix_plus_custom_field_definition_unique_lowername_resourcetype",
        "plus_custom_field_definition",
        ["resource_type", sa.text("lower(name)")],
        unique=True,
    )

    # Drop the unused enum type after all columns have been converted
    op.execute(f'DROP TYPE IF EXISTS "{PG_ENUM_NAME}"')
    # ### end Alembic commands ###


def downgrade():
    """
    This migration does not support downgrades.
    """
    logger.info("Conversion of str to enum ResourceType is unsupported.")
